<!doctype html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Tasdiqlash - Hamkor Talim</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        text-align: center;
      }

      .icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
        background: #10b981;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
      }

      .icon.error {
        background: #ef4444;
      }

      .icon.loading {
        background: #3b82f6;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      h1 {
        color: #1f2937;
        margin-bottom: 10px;
        font-size: 24px;
      }

      p {
        color: #6b7280;
        margin-bottom: 30px;
        line-height: 1.6;
      }

      .button {
        display: inline-block;
        padding: 12px 24px;
        background: #667eea;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 500;
        margin-top: 10px;
        transition: background 0.3s;
      }

      .button:hover {
        background: #5568d3;
      }

      .button-secondary {
        background: #e5e7eb;
        color: #374151;
      }

      .button-secondary:hover {
        background: #d1d5db;
      }

      .status {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .status.success {
        background: #d1fae5;
        color: #065f46;
      }

      .status.error {
        background: #fee2e2;
        color: #991b1b;
      }

      .status.info {
        background: #dbeafe;
        color: #1e40af;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="icon loading" id="icon">⏳</div>
      <h1 id="title">Email tasdiqlanmoqda...</h1>
      <p id="message">Iltimos, kuting...</p>
      <div id="status"></div>
      <div id="actions"></div>
    </div>

    <script>
      // URL parametrlarini olish (hash va query string'dan)
      function getUrlParams() {
        const params = {};
        const fullUrl = window.location.href;

        console.log('Full URL:', fullUrl);
        console.log('Search:', window.location.search);
        console.log('Hash:', window.location.hash);
        console.log('Pathname:', window.location.pathname);

        // Query string parametrlarini olish (?key=value)
        if (window.location.search) {
          const queryParams = new URLSearchParams(window.location.search);
          queryParams.forEach((value, key) => {
            params[key] = value;
            console.log(`Query param: ${key} = ${value}`);
          });
        }

        // Hash parametrlarini olish (#key=value yoki #access_token=xxx&type=xxx)
        if (window.location.hash) {
          const hash = window.location.hash.substring(1); // # ni olib tashlash
          console.log('Hash string:', hash);

          // Hash'ni parse qilish
          if (hash.includes('=')) {
            const hashParams = new URLSearchParams(hash);
            hashParams.forEach((value, key) => {
              params[key] = value;
              console.log(`Hash param: ${key} = ${value}`);
            });
          }
        }

        // URL path'dan ham parametrlar olish (agar Supabase redirect qilgan bo'lsa)
        // Masalan: /email-confirmation?token_hash=xxx
        const pathParts = window.location.pathname.split('/');
        console.log('Path parts:', pathParts);

        return params;
      }

      const urlParams = getUrlParams();
      const tokenHash =
        urlParams.token_hash || urlParams.access_token || urlParams.token;
      const type = urlParams.type || 'signup';
      const email = urlParams.email;
      const confirmed = urlParams.confirmed === 'true'; // Supabase tasdiqlagandan keyin qaytadi

      // Debug uchun console'ga chiqarish
      console.log('=== URL PARAMETRLARI ===');
      console.log('URL Params object:', urlParams);
      console.log('Token Hash:', tokenHash);
      console.log('Type:', type);
      console.log('Email:', email);
      console.log('========================');

      // Deep link ochish funksiyasi (global)
      const openDeepLink = (email) => {
        const deepLink = `hamkor-talim://email-confirmation?email=${encodeURIComponent(email || '')}`;

        // Avval deep link'ni ochishga harakat qilamiz
        window.location.href = deepLink;

        // Agar 2 soniyadan keyin hali ham sahifada bo'lsak, ilova ochilmagan
        setTimeout(() => {
          // Fallback: Play Store yoki App Store'ga yo'naltirish
          const userAgent =
            navigator.userAgent || navigator.vendor || window.opera;
          if (/android/i.test(userAgent)) {
            // Android uchun Play Store
            window.location.href =
              'https://play.google.com/store/apps/details?id=uz.hamkor.talim';
          } else if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
            // iOS uchun App Store
            window.location.href =
              'https://apps.apple.com/app/hamkor-talim/id123456789'; // O'z App Store URL'ingizni qo'ying
          }
        }, 2000);
      };

      // Global funksiya yaratish
      window.openApp = (email) => openDeepLink(email);

      // Supabase konfiguratsiyasi
      // Bu qiymatlarni o'z Supabase loyihangizdan oling
      const SUPABASE_URL = window.location.hostname.includes('localhost')
        ? 'https://skmoaeimhufhetmntiie.supabase.co' // Development
        : 'https://skmoaeimhufhetmntiie.supabase.co'; // Production
      const SUPABASE_ANON_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNrbW9hZWltaHVmaGV0bW50aWllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjY4NjIsImV4cCI6MjA3ODYwMjg2Mn0.TkUAf9S2may5WIjXhCWWsKHwlAKmhEfGp8_PNLJfHzo';

      async function confirmEmail() {
        const icon = document.getElementById('icon');
        const title = document.getElementById('title');
        const message = document.getElementById('message');
        const status = document.getElementById('status');
        const actions = document.getElementById('actions');

        // Debug ma'lumotlarini ekranda ko'rsatish (mobil uchun)
        const debugInfo = `
          <div class="status info" style="text-align: left; font-size: 12px; margin-top: 20px;">
            <strong>Debug ma'lumotlari:</strong><br>
            <small>Token Hash: ${tokenHash || "yo'q"}</small><br>
            <small>Type: ${type || "yo'q"}</small><br>
            <small>Email: ${email || "yo'q"}</small><br>
            <small>Full URL: ${window.location.href}</small><br>
            <small>Supabase URL: ${SUPABASE_URL}</small><br>
            <small>Supabase Key: ${SUPABASE_ANON_KEY ? SUPABASE_ANON_KEY.substring(0, 20) + '...' : "yo'q"}</small>
          </div>
        `;

        // Debug ma'lumotlari
        console.log('Checking params:', { tokenHash, type, email, confirmed });
        console.log('Supabase URL:', SUPABASE_URL);
        console.log(
          'Supabase Key:',
          SUPABASE_ANON_KEY
            ? SUPABASE_ANON_KEY.substring(0, 20) + '...'
            : 'NOT SET',
        );

        // Agar Supabase allaqachon tasdiqlagan bo'lsa (redirect_to orqali qaytgan)
        if (confirmed) {
          icon.className = 'icon';
          icon.textContent = '✅';
          title.textContent = 'Email tasdiqlandi!';
          message.textContent =
            'Hisobingiz muvaffaqiyatli tasdiqlandi. Endi mobil ilovaga qaytishingiz mumkin.';
          status.innerHTML =
            '<div class="status success">Email muvaffaqiyatli tasdiqlandi!</div>';

          actions.innerHTML = `
                    <button onclick="openApp('${email || ''}')" class="button" id="openApp" style="border: none; cursor: pointer; width: 100%;">Mobil ilovani ochish</button>
                    <br>
                    <button onclick="window.location.reload()" class="button button-secondary" style="margin-top: 10px; border: none; cursor: pointer; width: 100%;">Sahifani yangilash</button>
                `;

          // Avtomatik ravishda ochishga harakat qilish
          setTimeout(() => {
            openDeepLink(email);
          }, 2000);
          return;
        }

        if (!tokenHash) {
          icon.className = 'icon error';
          icon.textContent = '❌';
          title.textContent = 'Xatolik';
          message.textContent = 'Tasdiqlash linkida token topilmadi.';
          status.innerHTML = `
                    <div class="status error">
                        <strong>Muammo:</strong> Token hash topilmadi.<br>
                        <small>URL: ${window.location.href}</small><br>
                        <small>Hash: ${window.location.hash || "yo'q"}</small><br>
                        <small>Query: ${window.location.search || "yo'q"}</small>
                    </div>
                    ${debugInfo}
                `;
          actions.innerHTML =
            '<button onclick="window.location.reload()" class="button button-secondary" style="border: none; cursor: pointer;">Sahifani yangilash</button>';
          return;
        }

        // Type tekshirish (signup yoki recovery)
        if (type && type !== 'signup' && type !== 'recovery') {
          icon.className = 'icon error';
          icon.textContent = '❌';
          title.textContent = 'Xatolik';
          message.textContent = "Noto'g'ri tasdiqlash turi.";
          status.innerHTML =
            '<div class="status error">Type: ' + type + '</div>';
          actions.innerHTML =
            '<button onclick="window.location.reload()" class="button button-secondary" style="border: none; cursor: pointer;">Sahifani yangilash</button>';
          return;
        }

        // Xatolik ma'lumotlarini saqlash uchun o'zgaruvchilar
        let verifyUrl = null;
        let responseStatus = null;
        let responseData = null;
        let errorDetails = null;

        try {
          // Supabase email confirmation uchun to'g'ri endpoint
          // Supabase'da email confirmation avtomatik ishlaydi, lekin biz verify qilishimiz kerak

          // Variant 1: Token hash orqali verify qilish

          if (tokenHash && !tokenHash.includes('.')) {
            // Supabase'ning default flow'ini ishlatish
            // Linkni to'g'ridan-to'g'ri Supabase verify endpoint'iga yo'naltiramiz
            // Supabase o'zi email'ni tasdiqlaydi va keyin redirect_to URL'iga yo'naltiradi
            verifyUrl = new URL(`${SUPABASE_URL}/auth/v1/verify`);
            verifyUrl.searchParams.set('token', tokenHash); // 'token' parametri
            if (type) {
              verifyUrl.searchParams.set('type', type);
            }
            // Redirect URL'ni qo'shamiz (Supabase tasdiqlagandan keyin qaytadi)
            const redirectUrl = `${window.location.origin}${window.location.pathname}?confirmed=true&email=${encodeURIComponent(email || '')}`;
            verifyUrl.searchParams.set('redirect_to', redirectUrl);

            // Fetch o'rniga, to'g'ridan-to'g'ri Supabase verify endpoint'iga redirect qilamiz
            console.log(
              'Redirecting to Supabase verify:',
              verifyUrl.toString(),
            );
            window.location.href = verifyUrl.toString();
            return; // Redirect qilgandan keyin kod to'xtaydi
          } else {
            // Access token format - bu allaqachon tasdiqlangan bo'lishi mumkin
            // Bu holda biz faqat foydalanuvchiga xabar ko'rsatamiz
            icon.className = 'icon';
            icon.textContent = '✅';
            title.textContent = 'Email tasdiqlandi!';
            message.textContent = 'Hisobingiz muvaffaqiyatli tasdiqlandi.';
            status.innerHTML =
              '<div class="status success">Email muvaffaqiyatli tasdiqlandi!</div>';

            actions.innerHTML = `
                        <button onclick="openApp('${email || ''}')" class="button" id="openApp" style="border: none; cursor: pointer; width: 100%;">Mobil ilovani ochish</button>
                        <br>
                        <button onclick="window.location.reload()" class="button button-secondary" style="margin-top: 10px; border: none; cursor: pointer; width: 100%;">Sahifani yangilash</button>
                    `;

            // Avtomatik ravishda ochishga harakat qilish
            setTimeout(() => {
              openDeepLink(email);
            }, 2000);
            return;
          }

          // Bu kod endi ishlamaydi, chunki yuqorida redirect qilindi
          // Supabase verify endpoint'iga redirect qilgandan keyin, Supabase o'zi email'ni tasdiqlaydi
          // va keyin redirect_to URL'iga yo'naltiradi (bizning sahifamizga confirmed=true bilan)
        } catch (error) {
          console.error('Error details:', error);
          icon.className = 'icon error';
          icon.textContent = '❌';
          title.textContent = 'Xatolik';
          message.textContent =
            error.message || 'Email tasdiqlashda xatolik yuz berdi.';

          // Xatolik ma'lumotlarini batafsil ko'rsatish
          const errorInfo = errorDetails || {
            type: error.name || 'Unknown Error',
            message: error.message || "Noma'lum xatolik",
          };

          const detailedErrorInfo = `
            <div class="status error" style="text-align: left; font-size: 12px; margin-top: 10px; max-height: 300px; overflow-y: auto;">
              <strong>Xatolik tafsilotlari:</strong><br>
              <small><strong>Xatolik turi:</strong> ${errorInfo.type || "Noma'lum"}</small><br>
              ${errorInfo.status ? `<small><strong>HTTP Status:</strong> ${errorInfo.status}</small><br>` : ''}
              <small><strong>Xatolik xabari:</strong> ${errorInfo.message || error.message || "Noma'lum"}</small><br>
              ${verifyUrl ? `<small><strong>Verify URL:</strong> <a href="${verifyUrl.toString()}" target="_blank" style="color: #3b82f6; word-break: break-all;">${verifyUrl.toString()}</a></small><br>` : ''}
              ${responseData ? `<small><strong>Response Data:</strong> <pre style="background: #f3f4f6; padding: 5px; border-radius: 4px; overflow-x: auto; font-size: 10px;">${JSON.stringify(responseData, null, 2).substring(0, 500)}${JSON.stringify(responseData).length > 500 ? '...' : ''}</pre></small><br>` : ''}
              ${error.stack ? `<small><strong>Stack Trace:</strong> <pre style="background: #f3f4f6; padding: 5px; border-radius: 4px; overflow-x: auto; font-size: 10px;">${error.stack.substring(0, 300)}...</pre></small><br>` : ''}
            </div>
          `;

          status.innerHTML = `
                    <div class="status error">
                        <strong>Xatolik:</strong> ${error.message || "Noma'lum xatolik"}<br>
                        <small>Iltimos, quyidagi ma'lumotlarni tekshiring:</small>
                    </div>
                    ${detailedErrorInfo}
                    ${debugInfo}
                `;
          actions.innerHTML = `
                    <a href="/" class="button button-secondary">Bosh sahifaga qaytish</a>
                `;
        }
      }

      // Sahifa yuklanganda email confirmation'ni bajarish
      window.addEventListener('load', confirmEmail);
    </script>
  </body>
</html>
